Check Ansible Installation:
*****************************
$ ansible --version

Establish SSH connection controller machine and host machine:
*************************

$ sudo su -

Establish SSH key pair in linux system to have SSH connectivity with localhost using the following commands:

$ ssh-keygen -t rsa (Press Enter when asked for File and Paraphrase details)

$ cd

$ cat .ssh/id_rsa.pub >> .ssh/authorized_keys

[OR] when connecting with public server host

$ ssh-copy-id -i username@ipHost

Add the host ‘localhost’  in ansible host file:

$ vim /etc/ansible/hosts

press i to insert data, scroll to the bottom and enter below text

[webserver]
localhost:22

Save the file . Esc key --> :wq --> enter key

Ad Hoc Commands in Ansible


$ ansible webserver -m ping
$ ansible webserver -m command -a "df -h"
$ ansible webserver -m command -a “uptime”


Playbooks:
==========================================

# cd /etc/ansible

# vim playbook1.yml

- name: debug and register module
  hosts: webserver
  tasks:
  - name: Print a message
    debug: msg="Ansible Playbook Execution"
  - name: Execute a command on the host server
    command: hostname -s
    register: hostname_output  # here we are creating a variable
  - name: Show the output
    debug: var=hostname_output.stdout

Save the file (:wq!)

Execute the playbook: 
# ansible-playbook playbook1.yml --syntax-check
# ansible-playbook playbook1.yml 



=======================================================
# vim playbook2.yml

- name: install a packge and create a file
  hosts: webserver
  tasks:
  - name: Install php on host server
    package: name=php state=present
  - name: create a file
    file: path=/tmp/file-new state=touch
  - name: install multiple packages
    package: name={{item}} state=present
    loop:
      - git
      - maven
      - nano
      - tree



save the file (:wq!)

# ansible-playbook playbook2.yml

===================================
# vim playbook4.yml

- name: Install packages and create a file
  hosts: localhost
  become: true
  become_user: root
  vars:
   pkg_name: git
   pkg_state: present
   file_path: /tmp/file2
   file_state: touch
  tasks:
  - name: Install {{pkg_name}} on hostserver
    package: name={{pkg_name}} state={{pkg_state}}
  - name: Create a file on hostserver
    file: path={{file_path}} state={{file_state}}


save the file(:wq) press enter key


# ansible-playbook playbook4.yml

=============================================
Pass Variable values at runtime:
==========================================

ansible-playbook playbook4.yml --extra-vars pkg_name=nano
ansible-playbook playbook4.yml --extra-vars "pkg_name=php file_path=/tmp/file3"


FACT VARIABLES:
=========================

# vim playbook5.yml

- hosts: localhost
  become: true
  become_user: root
  tasks:
  - name: Install package httpd
    package: name=httpd state=present
    when: ansible_os_family == "RedHat"
  - name: Install package apache2
    package: name=apache2 state=present
    when: ansible_os_family != "RedHat"


Save the file

# ansible-playbook playbook5.yml


# vim playbook6.yml

- hosts: webserver
  tasks:
  - name: Execute a command on the host
    command: hostname -s
    when: (ansible_distribution == "CentOS" and ansible_distribution_major_version == "8") or
          (ansible_distribution == "Ubuntu" and ansible_distribution_major_version == "20")

save the file

# ansible-playbook playbook6.yml

==========================================
Deploy HTML code on NGINX server


# vim index.html

<h1> This file is form Ansible </h1>
Deployed by Ansible controller

Save the file


# vim playbook7.yml


- name: Deploy HTML code in apache2 server
  hosts: webserver
  vars:
   pkg_name: nginx
   dest_path: /var/www/html
   service_state:
     - started
     - restarted
  tasks:
  - name: Install {{pkg_name}} package
    package: name={{pkg_name}} state=present
  - name: start the {{pkg_name}} service
    service: name={{pkg_name}} state={{service_state[0]}}
  - name: deploy html code
    copy: src=index.html dest={{dest_path}}
  - name: restart {{pkg_name}} service
    service: name={{pkg_name}} state={{service_state[1]}}


Save the playbook and run


# ansible-playbook playbook7.yml


open the browser of the lab and give 

localhost:80


you wills ee your app deployed

=========================================
Handlers in Ansible


Update the index.html file

# echo "update .." >> index.html

# vim playbook6.yml

- name: Deploy HTML code in apache2 server
  hosts: webserver
  vars:
   pkg_name: nginx
   dest_path: /var/www/html
   service_state:
     - started
     - restarted
  tasks:
  - name: Install {{pkg_name}} package
    package: name={{pkg_name}} state=present
  - name: start the {{pkg_name}} service
    service: name={{pkg_name}} state={{service_state[0]}}
  - name: deploy html code
    copy: src=index.html dest={{dest_path}}
    notify: restart {{pkg_name}} service
  - name: run a command
    command: hostname -s
    notify: print a message
  handlers:
  - name: restart {{pkg_name}} service
    service: name={{pkg_name}} state={{service_state[1]}}
  - name: print a message
    debug: msg="command exeucted successfully"



Save the file

# ansible-playbook playbook6.yml


===================================================
Jinja2 in Ansible
====================================================
# sudo su -
# cd /etc/ansible

# vim webfile.conf.j2

This file is a configuration file

This file is created at /etc directory of the system

This file consist of default paramters

Parameters_list:

hostname = {{ansible_nodename}}
IP address = {{ansible_default_ipv4["address"]}}
OS = {{ansible_os_family}}
sysadmin = {{admin_name}}

Save the file.

# vim filedemo.conf

This file is a configuration file

This file is created at /etc directory of the system

This file consist of default paramters

Parameters_list:

hostname = {{ansible_nodename}}
IP address = {{ansible_default_ipv4["address"]}}
OS = {{ansible_os_family}}
sysadmin = {{admin_name}}

Save the file


# vim playbookJinja2.yml

- name: Jinja2 Templates
  hosts: localhost
  become: true
  vars:
   admin_name: Ansible_admin
  tasks:
  - name: Copy a file using copy module
    copy: src=filedemo.conf dest=/etc
  - name: Copy a jinja2 file using template module
    template: src=webfile.conf.j2 dest=/etc/webfile.conf

Save the file and exeucte the playbook

Validate: 

# cat /etc/filedemo.conf

# cat /etc/webfile.conf


Ansible Roles:

==============================================

# sudo su -

# cd /etc/ansible

# cd roles

Create a role apache using ansible-galaxy

#  ansible-galaxy init nginx

# cd nginx

Delete the directory that  are not needed for this scenario

# rm -rf README.md meta tests

# sudo vim tasks/main.yml

  - name: Install nginx
    package: name={{pkg_name}} state=present
  - name: Start the nginx server
    service: name={{pkg_name}} state=started
  - name: Copy the html code on nginx server
    template: src=index.html.j2 dest={{dest_path}}
    notify: Restart Server


Save the file

Write the vars section for the playbook:
=========================
# sudo vim vars/main.yml

Press i to insert
pkg_name: nginx
dest_path: /var/www/html/index.html
email:
 - admin@gmail.com
 - ansible@gmail.com
 - admin2@gmail.com


Save the file

Write the template section:
==========================

#  sudo vim templates/index.html.j2


This is jinja2 template

The webserver is running on {{ ansible_hostname }}

# forloop in jinja2
# here email is a custome variable in playbook, which will have list of values

{% for item in email %}

The system admin contact email is: {{item}}

{% endfor %}


Save the file.

=============================
Enter data in handlers section
=============================

# sudo vim handlers/main.yml

  - name: Print a message
    debug: msg="apt-get repo Update complete"
  - name: Restart Server
    service: name={{pkg_name}} state=restarted



Save the file.

===============================

After this come out in the directory where you are writing playbooks

Note: the playbook that is calling the role is written in directory other than Roles directory


Execute the command

# cd

# cd /etc/ansible

# vim playbookRole1.yml


- hosts: localhost
  become: true
  roles:
   - nginx


Save the file

Execute the playbook, which inturn executes the role.


Demo 2:

# cd roles

# git clone https://github.com/Sonal0409/tomcat-role.git

# cd tomcat-role

# cd tasks
You will see all the yamls

# cd ../../..

create a playbook to run the role

playbookroles.yml

- name: Roles in ansible
  hosts: localhost
  roles:
    - tomcat-role


save the file and run

ansible-playbook playbookroles.yml -e "action=install"

OR

ansible-playbook playbookroles.yml -e "action=uninstall"
